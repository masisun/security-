<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Security+ Quiz â€“ DE (Upload- oder Fetch-Modus)</title>
<style>
  :root {
    --bg:#f7f7fb; --card:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    --primary:#2563eb; --primary-contrast:#fff; --good:#065f46; --bad:#991b1b; --warn:#92400e;
    --shadow:0 10px 30px rgba(0,0,0,.08);
  }
  [data-theme="dark"] {
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
    --primary:#3b82f6; --primary-contrast:#0b1220; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --shadow:0 10px 30px rgba(0,0,0,.5);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--card),transparent),var(--card);border-bottom:1px solid var(--border)}
  .wrap{max-width:980px;margin:0 auto;padding:16px;display:flex;gap:12px;align-items:center}
  .title{font-weight:800;font-size:18px;margin-right:auto}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
  .btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .06s ease, box-shadow .2s ease, background .2s;border-color:var(--border);box-shadow:var(--shadow)}
  .btn:active{transform:scale(.98)}
  .btn.primary{background:var(--primary);color:var(--primary-contrast);border-color:transparent}
  .btn.icon{display:inline-flex;align-items:center;gap:8px}
  .container{max-width:980px;margin:20px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
  .progressbar{height:10px;background:linear-gradient(90deg,#e5e7eb,transparent);border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .progressbar>div{height:100%;width:0%;background:var(--primary);transition:width .3s ease}
  .question{display:flex;flex-direction:column;gap:10px;min-height:220px}
  .qtext{font-size:18px;line-height:1.35}
  .options{display:grid;gap:10px}
  label.option{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:background .2s ease, transform .06s ease, border .2s}
  input[type="radio"], input[type="checkbox"]{transform:scale(1.15);margin-top:4px}
  label.option:hover{background:rgba(37,99,235,.06)}
  label.option.correct{border-color:var(--good);background:rgba(34,197,94,.08)}
  label.option.incorrect{border-color:var(--bad);background:rgba(239,68,68,.08)}
  .feedback{font-size:14px}
  .deck{display:grid;gap:16px}
  .nav{display:flex;gap:10px;justify-content:space-between;align-items:center}
  .meta{color:var(--muted);font-size:13px}
  .timer{font-variant-numeric:tabular-nums}
  .result{margin-top:12px;padding:14px;border-radius:12px;background:rgba(37,99,235,.08)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .hidden{display:none !important}
  .uploader{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .drop{border:2px dashed var(--border); padding:12px; border-radius:12px; color:var(--muted)}
  @media (max-width:640px){.grid2{grid-template-columns:1fr}.btn{width:100%}.options{gap:8px}.qtext{font-size:16px}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">Security+ Quiz â€“ DE <span class="badge" id="badgeCount">â€”</span></div>
    <button class="btn icon" id="themeBtn" aria-label="Theme">ðŸŒ™ Dunkel</button>
    <button class="btn icon" id="fsBtn" aria-label="Fullscreen">â›¶ Vollbild</button>
  </div>
</header>

<main class="container">

  <div class="card" id="uploadCard">
    <strong>JSON laden</strong>
    <div class="uploader">
      <input type="file" id="pickJson" accept=".json,application/json">
      <span class="meta">oder Datei hierher ziehen</span>
    </div>
    <div class="drop" id="drop">questions_de.json hier ablegen â€¦</div>
    <div class="meta" id="loadHint">Tipp: Wenn du diese Seite Ã¼ber http(s) lÃ¤dst, versucht sie automatisch <code>questions_de.json</code> per fetch zu laden.</div>
  </div>

  <div class="card" style="margin:16px 0;">
    <div class="grid2">
      <div class="row">
        <button class="btn" id="shuffleBtn">Fragen mischen</button>
        <button class="btn" id="resetBtn">ZurÃ¼cksetzen</button>
        <button class="btn primary" id="gradeBtn">Jetzt auswerten</button>
      </div>
      <div class="row">
        <span class="meta">Versuche: <strong id="attempts">0</strong></span>
        <span class="meta">Bestwert: <strong id="best">â€”</strong></span>
        <span class="meta">Timer: <strong class="timer" id="timer">45:00</strong></span>
        <button class="btn" id="startTimerBtn">Start</button>
        <button class="btn" id="stopTimerBtn">Stop</button>
      </div>
    </div>
    <div class="progressbar" style="margin-top:12px;"><div id="progress"></div></div>
  </div>

  <div class="card deck">
    <div class="nav">
      <button class="btn" id="prevBtn">â—€ ZurÃ¼ck</button>
      <div class="meta"><span id="qMeta">Frage â€” / â€”</span></div>
      <button class="btn" id="nextBtn">Weiter â–¶</button>
    </div>

    <div id="qCard" class="question">
      <div class="qtext" id="qText">Bitte JSON laden (Datei auswÃ¤hlen oder per Drag & Drop ablegen).</div>
      <div class="options" id="qOptions"></div>
      <div class="row">
        <button class="btn" id="checkBtn" disabled>Antwort prÃ¼fen</button>
        <button class="btn" id="redoWrongBtn" title="Nur falsch beantwortete Fragen erneut Ã¼ben" disabled>Nur falsche erneut Ã¼ben</button>
        <span id="qFeedback" class="feedback"></span>
      </div>
    </div>
  </div>

  <div id="summary" class="result hidden"></div>
</main>

<script>
const JSON_URL = "questions_de.json";

let QUESTIONS = [];
let order = [];
let idx = 0;
let selections = []; // { sel:number[], correct:boolean, checked:boolean }
let baseOrder = [];  // zum ZurÃ¼ckkehren nach "Nur falsche erneut Ã¼ben"
let countdown = 45*60, ticker = null;

function arraysEqual(a,b){
  if(a.length!==b.length) return false;
  const A=[...a].sort((x,y)=>x-y), B=[...b].sort((x,y)=>x-y);
  for(let i=0;i<A.length;i++) if(A[i]!==B[i]) return false;
  return true;
}

function renderTimer(){
  const m = Math.floor(countdown/60).toString().padStart(2,'0');
  const s = (countdown%60).toString().padStart(2,'0');
  document.getElementById('timer').textContent = m+':'+s;
}

function renderProgress(){
  if(order.length===0){ document.getElementById('progress').style.width='0%'; return; }
  const answered = selections.filter(s=>s.checked).length;
  const pct = Math.round((answered/order.length)*100);
  document.getElementById('progress').style.width = pct+'%';
  document.getElementById('qMeta').textContent = `Frage ${Math.min(idx+1,order.length)} / ${order.length} â€¢ Beantwortet ${answered}/${order.length}`;
}

function enableUI(enabled){
  ['checkBtn','redoWrongBtn','shuffleBtn','resetBtn','gradeBtn','prevBtn','nextBtn'].forEach(id=>{
    const b = document.getElementById(id);
    if(!b) return;
    b.disabled = !enabled;
  });
}

function renderCard(){
  if(order.length===0) return;
  const q = QUESTIONS[order[idx]];
  const qText = document.getElementById('qText');
  const qOpts = document.getElementById('qOptions');
  const qFeedback = document.getElementById('qFeedback');
  qText.textContent = q.text;
  qOpts.innerHTML = '';
  qFeedback.textContent = '';
  const sel = selections[order[idx]].sel;

  q.options.forEach((opt,i)=>{
    const wrap = document.createElement('label');
    wrap.className='option';
    const input = document.createElement('input');
    input.type = q.multi ? 'checkbox' : 'radio';
    input.name = 'q'+order[idx];
    input.value = i;
    if(sel.includes(i)) input.checked = true;
    input.addEventListener('change', ()=>{
      const curr = selections[order[idx]].sel;
      if(q.multi){
        if(input.checked) curr.push(i); else selections[order[idx]].sel = curr.filter(x=>x!==i);
      } else {
        selections[order[idx]].sel = [i];
      }
    });
    const span = document.createElement('span');
    span.textContent = String.fromCharCode(65+i)+". "+opt;
    wrap.appendChild(input);
    wrap.appendChild(span);
    qOpts.appendChild(wrap);
  });

  document.getElementById('checkBtn').onclick = ()=>{
    const sel = selections[order[idx]].sel;
    const ok = arraysEqual(sel, q.correct);
    selections[order[idx]].correct = ok;
    selections[order[idx]].checked = true;

    const labels = [...qOpts.querySelectorAll('label.option')];
    labels.forEach(l=>l.classList.remove('correct','incorrect'));
    q.correct.forEach(i => labels[i]?.classList.add('correct'));
    sel.forEach(i => { if(!q.correct.includes(i)) labels[i]?.classList.add('incorrect'); });

    const fb = document.getElementById('qFeedback');
    fb.textContent = ok ? 'âœ… Richtig' : 'âŒ Falsch â€“ richtige Antwort ist markiert';
    fb.style.color = ok ? 'var(--good)' : 'var(--bad)';
    renderProgress();
  };

  renderProgress();
}

function grade(){
  if(order.length===0) return;
  selections.forEach(s=>{ if(!s.checked) s.checked = true; });
  let score = 0;
  selections.forEach((s,i)=>{ if(arraysEqual(s.sel, QUESTIONS[order[i]].correct)) score++; });
  const pct = Math.round((score/order.length)*100);
  const summary = document.getElementById('summary');
  summary.classList.remove('hidden');
  summary.innerHTML = `<strong>Ergebnis:</strong> ${score} / ${order.length} (${pct}%)`;

  const ATT_KEY='quiz_attempts_de', BEST_KEY='quiz_best_de';
  const attempts = (parseInt(localStorage.getItem(ATT_KEY)||'0',10)+1);
  const best = Math.max(parseInt(localStorage.getItem(BEST_KEY)||'-1',10), pct);
  localStorage.setItem(ATT_KEY, attempts);
  localStorage.setItem(BEST_KEY, best);
  document.getElementById('attempts').textContent = attempts;
  document.getElementById('best').textContent = best>=0 ? (best+'%') : 'â€”';
}

function shuffle(){
  for(let i=order.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [order[i],order[j]]=[order[j],order[i]]; }
  idx=0; renderCard();
}

function resetAll(){
  order = [...Array(QUESTIONS.length).keys()];
  baseOrder = order.slice();
  idx = 0;
  selections = Array(QUESTIONS.length).fill(null).map(()=>({sel:[], correct:false, checked:false}));
  countdown = 45*60; renderTimer();
  document.getElementById('summary').classList.add('hidden');
  renderCard();
}

function redoWrong(){
  const wrongIdx = order.filter((_,pos)=> selections[order[pos]].checked && !selections[order[pos]].correct);
  if(wrongIdx.length === 0){
    alert("Es gibt aktuell keine falsch beantworteten Fragen. Nutze 'Jetzt auswerten' oder 'Antwort prÃ¼fen'.");
    return;
  }
  baseOrder = order.slice();
  order = wrongIdx.slice();
  idx = 0;
  renderCard();
}

function installUploadHandlers(loadCb){
  const pick = document.getElementById('pickJson');
  const drop = document.getElementById('drop');

  async function handleFile(file){
    const txt = await file.text();
    const data = JSON.parse(txt);
    loadCb(data);
  }

  pick.addEventListener('change', ev=>{
    const f = ev.target.files && ev.target.files[0];
    if(f) handleFile(f);
  });

  ;['dragenter','dragover'].forEach(evt=> drop.addEventListener(evt, e=>{
    e.preventDefault(); e.stopPropagation(); drop.style.background='rgba(37,99,235,.06)';
  }));
  ;['dragleave','drop'].forEach(evt=> drop.addEventListener(evt, e=>{
    e.preventDefault(); e.stopPropagation(); drop.style.background='transparent';
  }));
  drop.addEventListener('drop', e=>{
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if(f) handleFile(f);
  });
}

function enableAfterLoad(){
  enableUI(true);
  document.getElementById('checkBtn').disabled = false;
  document.getElementById('redoWrongBtn').disabled = false;
  document.getElementById('uploadCard').classList.add('hidden');
}

async function boot(){
  // Theme
  const root = document.documentElement;
  const storedTheme = localStorage.getItem('quiz_theme');
  if(storedTheme) root.setAttribute('data-theme', storedTheme);
  const themeBtn = document.getElementById('themeBtn');
  const setThemeBtn = ()=> themeBtn.textContent = (root.getAttribute('data-theme')==='dark') ? 'â˜€ï¸ Hell' : 'ðŸŒ™ Dunkel';
  themeBtn.addEventListener('click', ()=>{
    const next = root.getAttribute('data-theme')==='dark' ? 'light' : 'dark';
    root.setAttribute('data-theme', next);
    localStorage.setItem('quiz_theme', next);
    setThemeBtn();
  });
  setThemeBtn();

  // Fullscreen
  document.getElementById('fsBtn').addEventListener('click', async ()=>{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  });

  // Timer
  renderTimer();
  document.getElementById('startTimerBtn').addEventListener('click', ()=>{
    if(window._ticker) return;
    window._ticker = setInterval(()=>{
      countdown--; renderTimer();
      if(countdown<=0){ clearInterval(window._ticker); window._ticker=null; grade(); }
    }, 1000);
  });
  document.getElementById('stopTimerBtn').addEventListener('click', ()=>{ if(window._ticker){ clearInterval(window._ticker); window._ticker=null; } });

  // Upload handlers (works for file://)
  installUploadHandlers((data)=>{
    QUESTIONS = data;
    document.getElementById('badgeCount').textContent = `${QUESTIONS.length} Fragen`;
    order = [...Array(QUESTIONS.length).keys()];
    baseOrder = order.slice();
    selections = Array(QUESTIONS.length).fill(null).map(()=>({sel:[], correct:false, checked:false}));
    enableAfterLoad();
    renderCard();
  });

  // Try fetch when served via http(s)
  if (location.protocol === 'http:' || location.protocol === 'https:'){
    try{
      const res = await fetch(JSON_URL, {cache:'no-store'});
      if(res.ok){
        QUESTIONS = await res.json();
        document.getElementById('badgeCount').textContent = `${QUESTIONS.length} Fragen`;
        order = [...Array(QUESTIONS.length).keys()];
        baseOrder = order.slice();
        selections = Array(QUESTIONS.length).fill(null).map(()=>({sel:[], correct:false, checked:false}));
        enableAfterLoad();
        renderCard();
      }
    }catch(e){
      // ignore; user can upload
    }
  } else {
    enableUI(false); // until user uploads
  }

  // Stats
  document.getElementById('attempts').textContent = parseInt(localStorage.getItem('quiz_attempts_de')||'0',10);
  const b = parseInt(localStorage.getItem('quiz_best_de')||'-1',10);
  document.getElementById('best').textContent = b>=0 ? (b+'%') : 'â€”';

  // Controls
  document.getElementById('shuffleBtn').addEventListener('click', shuffle);
  document.getElementById('resetBtn').addEventListener('click', resetAll);
  document.getElementById('gradeBtn').addEventListener('click', grade);
  document.getElementById('prevBtn').addEventListener('click', ()=>{ if(idx>0){ idx--; renderCard(); } });
  document.getElementById('nextBtn').addEventListener('click', ()=>{ if(idx<order.length-1){ idx++; renderCard(); } });
  document.getElementById('redoWrongBtn').addEventListener('click', redoWrong);
}

boot();
</script>
</body>
</html>
